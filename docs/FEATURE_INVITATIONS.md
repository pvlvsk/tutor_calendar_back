# Функциональность приглашений

## Обзор

Система приглашений позволяет связывать пользователей разных ролей:
- **Учитель → Ученик** (код `T_xxx`)
- **Ученик → Родитель** (код `P_xxx`)

## Типы ссылок

| Тип | Формат | Генерируется | Принимается |
|-----|--------|--------------|-------------|
| Учитель → Ученик | `T_xxx` | Учителем в профиле | Любым пользователем |
| Ученик → Родитель | `P_xxx` | Учеником в профиле | Любым пользователем |

## Сценарии принятия приглашения

### 1. Новый пользователь

1. Пользователь переходит по ссылке `t.me/bot?startapp=T_xxx`
2. Создаётся новый аккаунт с ролью "ученик"
3. Устанавливается связь с учителем
4. Показывается модалка: **"Приглашение принято! Вы стали учеником у [Учитель]"**

### 2. Существующий пользователь с другой ролью

1. Учитель переходит по ссылке `startapp=T_xxx`
2. Добавляется роль "ученик"
3. Переключается на роль "ученик"
4. Показывается модалка: **"Приглашение принято! Сейчас вы вошли как ученик. Чтобы сменить роль, перейдите в Профиль → Сменить роль"**

### 3. Существующий ученик → к новому учителю

1. Ученик переходит по ссылке `startapp=T_xxx` (другого учителя)
2. Устанавливается связь с новым учителем
3. Роль НЕ меняется (остаётся "ученик")
4. Показывается модалка: **"Новый учитель! У вас появился новый учитель: [Учитель]"**

## Frontend компоненты

### InvitationPage

Страница обработки приглашения:
- Показывает лоадер "Принимаем приглашение..."
- При ошибке показывает сообщение и кнопку "На главную"

**Путь:** `pages/auth/InvitationPage.tsx`

### InvitationResultModal

Модальное окно с результатом принятия:
- Показывается после успешного принятия
- Различает сценарии (смена роли / новый учитель)
- Кнопка "Понятно" закрывает модалку

**Путь:** `features/auth/ui/InvitationResultModal/`

## Backend API

### POST /api/auth/join

```json
{
  "initData": "<telegram-init-data>",
  "referralCode": "T_xxx"
}
```

**Response:**
```json
{
  "user": { ... },
  "roles": ["student"],
  "currentRole": "student",
  "token": "jwt-token",
  "teacher": {
    "id": "uuid",
    "displayName": "Иван Петров"
  }
}
```

## Redux State

```typescript
interface AuthState {
  // ... другие поля
  invitationToken: string | null;      // Код приглашения из URL
  invitationResult: InvitationResult | null;  // Результат принятия
}

interface InvitationResult {
  teacher?: { id: string; displayName: string };
  student?: { id: string; name?: string };
  previousRole: UserRole | null;  // Роль до принятия (из localStorage)
  newRole: UserRole;              // Новая роль
}
```

## Определение типа модалки

```typescript
// Роль изменилась?
const roleChanged = previousRole !== newRole;

if (roleChanged) {
  // "Приглашение принято! Вы стали учеником у..."
} else {
  // "Новый учитель! У вас появился новый учитель..."
}
```

## Тестирование

См. `tutor_calendar_docs/LOCAL_TESTING.md`:
- Сценарий 4: Учитель становится учеником
- Сценарий 5: Ученик добавляется к новому учителю
